<!-- pages/goals/detail/detail.wxml -->
<view class="detail-container">
  <view class="header">
    <view class="title">ç›®æ ‡è¯¦æƒ…</view>
    <view class="dropdown-menu" bindtap="showActionMenu">
      <text class="menu-icon">â€¢â€¢â€¢</text>
    </view>
  </view>
  
  <!-- æ“ä½œèœå• -->
  <view class="action-menu" wx:if="{{showMenu}}">
    <view class="menu-item" bindtap="editGoal">
      <text>ç¼–è¾‘</text>
      <text class="menu-icon">âœ</text>
    </view>
    <view class="menu-item" bindtap="completeGoal">
      <text>å®Œæˆç›®æ ‡</text>
      <text class="menu-icon">âœ“</text>
    </view>
    <view class="menu-item delete" bindtap="deleteGoal" data-delete-tasks="true">
      <text>åˆ é™¤</text>
      <text class="menu-icon">ğŸ—‘</text>
    </view>
  </view>

  <block wx:if="{{loading}}">
    <t-loading theme="circular" size="40rpx" class="loading-center">åŠ è½½ä¸­...</t-loading>
  </block>
  
  <block wx:elif="{{goal}}">
    <view class="goal-card">
      <view class="goal-header" style="background-color: {{goal.color || '#FF6B9A'}}">
        <view class="goal-title">{{goal.title}}</view>
        <text wx:if="{{goal.completed}}" class="completed-tag">å·²å®Œæˆ</text>
      </view>
      
      <view class="goal-info">
        <view class="info-item">
          <text class="info-value">{{goal.createTime ? goal.createTime.substring(0, 10) : 'æ— '}}</text>
        </view>
        
        <view class="info-item">
          <text class="info-label">ç›®æ ‡æ—¶é—´ï¼š</text>
          <text class="info-value">{{formatDate || 'æ— '}}</text>
        </view>
        
        <view wx:if="{{goal.completed}}" class="info-item">
          <text class="info-label">å®Œæˆæ—¶é—´ï¼š</text>
          <text class="info-value">{{goal.completedTime ? goal.completedTime.substring(0, 10) : 'æ— '}}</text>
        </view>
      </view>
      
      <view wx:if="{{goal.description}}" class="goal-description">
        <text class="description-label">æè¿°</text>
        <text class="description-content">{{goal.description}}</text>
      </view>
      
      <!-- ä»»åŠ¡åˆ—è¡¨åŒºåŸŸ -->
      <view class="tasks-section">
        <view class="section-header">
          <view class="section-title">ç›®æ ‡ä»»åŠ¡</view>
          <view class="task-stats">
            <view class="stat-item">
              <text class="stat-label">å‰©ä½™{{remainingDays}}å¤©</text>
              <text class="stat-date">{{goal.endDate}} æˆªæ­¢</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">{{progressPercentage}}%</text>
              <text class="stat-desc">ç›®æ ‡è¿›åº¦</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">{{completedTasksCount}}</text>
              <text class="stat-desc">å·²å®Œæˆæ¬¡æ•°</text>
            </view>
          </view>
        </view>
        
        <view class="tasks-list">
          <view class="waiting-tasks">å¾…åŠä»»åŠ¡ {{tasks.length - completedTasksCount}}</view>
          
          <!-- AIåˆ›å»ºä»»åŠ¡æŒ‰é’® -->
          <view class="ai-task-btn" bindtap="createAITasks">
            <t-button theme="primary" size="small" icon="lightning" class="ai-btn">AIåˆ›å»ºä»»åŠ¡</t-button>
          </view>
          
          <!-- ä»»åŠ¡åˆ—è¡¨ -->
          <block wx:if="{{tasks.length > 0}}">
            <view class="task-items">
              <view 
                wx:for="{{tasks}}" 
                wx:key="id" 
                class="task-item"
                bindtap="viewTaskDetail"
                data-id="{{item.id}}"
              >
                <view class="task-checkbox {{item.completed ? 'checked' : ''}}" bindtap="toggleTaskStatus" data-id="{{item.id}}">
                  <view class="checkbox-inner"></view>
                </view>
                <view class="task-content">
                  <view class="task-title">{{item.title}}</view>
                </view>
                <view class="task-info" wx:if="{{item.startDate || item.endDate}}">
                    <text class="task-date">{{item.startDate || ''}}{{item.startDate && item.endDate ? ' ~ ' : ''}}{{item.endDate || ''}}</text>
                  </view>
                  <view class="task-desc" wx:if="{{item.description}}">{{item.description}}</view>
                  <view class="task-quantify" wx:if="{{item.enableQuantify && item.quantifyValue}}">
                    <text class="quantify-value">{{item.quantifyValue}}</text>
                  </view>
                  <view class="task-actions">
                    <view class="edit-btn" bindtap="editTask" data-id="{{item.id}}">
                      <t-icon name="edit" size="32rpx" color="#0052d9"></t-icon>
                    </view>
                    <view class="delete-btn" bindtap="deleteTask" data-id="{{item.id}}">
                      <t-icon name="delete" size="32rpx" color="#e34d59"></t-icon>
                    </view>
                  </view>
                </view>
              </view>
          </block>
          
          <!-- ç©ºçŠ¶æ€ -->
          <view class="empty-tasks" wx:if="{{tasks.length === 0}}">
            <view class="empty-box-image"></view>
            <view class="empty-text">å‡†å¤‡å¥½åˆ›å»ºä»»åŠ¡äº†å—ï¼Ÿ</view>
            <button class="create-btn" bindtap="createTask">åˆ›å»ºä»»åŠ¡</button>
          </view>
          
          <!-- æ·»åŠ ä»»åŠ¡æŒ‰é’® -->
          <view class="add-task-btn-container" wx:if="{{tasks.length > 0}}">
            <button class="create-btn" bindtap="createTask">æ·»åŠ ä»»åŠ¡</button>
          </view>
        </view>
      </view>
    </view>
  </block>
</view>