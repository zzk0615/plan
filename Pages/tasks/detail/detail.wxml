<!-- Pages/tasks/detail/detail.wxml -->
<!-- å¼•å…¥å­è®¡åˆ’æ ‘çŠ¶ç»“æ„æ¨¡æ¿ -->
<import src="./subtask-template.wxml" />
<view class="detail-container">
  <view class="header">
    <view class="title">ä»»åŠ¡è¯¦æƒ…</view>
    <view class="action-buttons">
      <view class="dropdown-menu" bindtap="showActionMenu">
        <text class="menu-icon">â€¢â€¢â€¢</text>
      </view>
    </view>
  </view>
  
  <!-- æ“ä½œèœå• -->
  <view class="action-menu-popup" wx:if="{{showMenu}}">
    <view class="menu-item" bindtap="onEditTap">
      <text>ç¼–è¾‘</text>
      <text class="menu-icon">âœ</text>
    </view>
    <view class="menu-item delete" bindtap="onDelete">
      <text>åˆ é™¤</text>
      <text class="menu-icon">ğŸ—‘</text>
    </view>
  </view>

  <block wx:if="{{loading}}">
    <t-loading theme="circular" size="40rpx" class="loading-center">åŠ è½½ä¸­...</t-loading>
  </block>

  <block wx:else>
    
    <t-cell-group>
      <t-cell title="ä»»åŠ¡åç§°" description="{{task.title}}" bordered="{{false}}" t-class-description="cell-description"></t-cell>
      <t-cell wx:if="{{task.description && task.description !== ''}}" title="æè¿°" description="{{task.description}}" bordered="{{false}}" t-class-description="cell-description"></t-cell>
      <t-cell wx:if="{{task.remark}}" title="å¤‡æ³¨" description="{{task.remark}}" bordered="{{false}}" t-class-description="cell-description"></t-cell>
      <t-cell title="æ—¥æœŸ">
        <view slot="description">
          <text wx:if="{{task.dateType === 'single'}}">{{task.singleDate}}</text>
          <text wx:if="{{task.dateType === 'range'}}">{{task.startDate}} è‡³ {{task.endDate}}</text>
        </view>
      </t-cell>

      <t-cell wx:if="{{task.enableQuantify}}" title="é‡åŒ–æ•°å€¼" description="{{task.quantifyValue}}"></t-cell>

      <t-cell wx:if="{{task.completed}}" title="å®Œæˆæ—¶é—´" description="{{task.completedTime ? task.completedTime.substring(0, 10) : ''}}"></t-cell>

      <t-cell wx:if="{{task.goalId}}" title="å…³è”ç›®æ ‡" description="{{task.goalTitle || 'æ— '}}"></t-cell>
    </t-cell-group>
  </block>

  <!-- è®¡æ—¶å™¨åŠŸèƒ½ -->
  <view class="timer-section" wx:if="{{!loading}}">
    <t-cell title="ä¸“æ³¨æ—¶é•¿" hover arrow bindtap="showTimerModal">
      <view slot="description" class="timer-info">
        <text wx:if="{{totalFocusTime > 0}}">å·²ä¸“æ³¨: {{formatFocusTime}}</text>
        <text wx:else>ç‚¹å‡»å¼€å§‹è®¡æ—¶</text>
      </view>
      <t-icon name="time" slot="left-icon" color="#0052d9"></t-icon>
    </t-cell>
  </view>
  
  <!-- æ€»ä½“å®Œæˆç‡æ˜¾ç¤º -->
    <view class="overall-progress-section">
      <view class="progress-header">
        <text class="progress-title">æ€»ä½“å®Œæˆç‡</text>
        <text class="progress-percentage">{{totalCompletionRate}}%</text>
      </view>
      <view class="progress-bar-container">
        <view class="progress-bar-bg">
          <view class="progress-bar-fill" style="width: {{totalCompletionRate}}%"></view>
        </view>
      </view>
    </view>
    
  <!-- å­è®¡åˆ’åŠŸèƒ½ -->
  <view class="subtasks-section" wx:if="{{!loading}}">
    <view class="section-header">
      <view class="section-title">
        <text>å­è®¡åˆ’</text>
        <text class="subtask-count" wx:if="{{subtasks.length > 0}}">({{completedSubtasksCount}}/{{subtasks.length}})</text>
      </view>
      <view class="add-subtask-btn" bindtap="showAddSubtaskModal">
        <t-icon name="add" size="48rpx" color="#0052d9"></t-icon>
      </view>
    </view>
    
    <!-- å­è®¡åˆ’åˆ—è¡¨ -->
    <view class="subtasks-list" wx:if="{{subtasks.length > 0}}">
      <view 
        wx:for="{{subtasks}}" 
        wx:key="id" 
        class="subtask-item {{item.completed ? 'completed' : ''}}">
        <view class="subtask-header">
          <view class="subtask-content">
            <view class="subtask-checkbox" catchtap="toggleSubtaskStatus" data-id="{{item.id}}">
              <t-icon name="{{item.completed ? 'check-circle-filled' : 'circle'}}" size="40rpx" color="{{item.completed ? '#0052d9' : '#999'}}"></t-icon>
            </view>
            <view class="subtask-info" bindtap="toggleSubtaskExpand" data-id="{{item.id}}">
              <view class="subtask-title">{{item.title}}</view>
              <view class="subtask-progress" wx:if="{{item.subtasks && item.subtasks.length > 0}}">
                <text class="subtask-children-count">{{item.completedSubtasksCount}}/{{item.subtasks.length}} å­è®¡åˆ’</text>
                <view class="progress-bar">
                  <view class="progress-fill" style="width: {{item.completionPercentage}}%"></view>
                </view>
                <text class="progress-percentage">{{item.completionPercentage}}%</text>
              </view>
            </view>
          </view>
          <view class="subtask-actions">
            <view class="subtask-action" catchtap="viewSubtaskDetail" data-id="{{item.id}}">
              <t-icon name="browse" size="36rpx" color="#666"></t-icon>
            </view>
            <view class="subtask-action" catchtap="editSubtask" data-id="{{item.id}}">
              <t-icon name="edit" size="36rpx" color="#666"></t-icon>
            </view>
            <view class="subtask-action" catchtap="deleteSubtask" data-id="{{item.id}}">
              <t-icon name="delete" size="36rpx" color="#666"></t-icon>
            </view>
            <view class="expand-icon" catchtap="toggleSubtaskExpand" data-id="{{item.id}}" wx:if="{{item.subtasks && item.subtasks.length > 0}}">
              <t-icon name="{{item.expanded ? 'chevron-up' : 'chevron-down'}}" size="36rpx" color="#666"></t-icon>
            </view>
          </view>
        </view>
        
        <!-- åµŒå¥—å­è®¡åˆ’ - æ— é™å±‚çº§æ ‘çŠ¶ç»“æ„ -->
        <view class="nested-subtasks tree-view" wx:if="{{item.expanded && item.subtasks && item.subtasks.length > 0}}">
          <template is="subtask-tree-item" data="{{subtasks: item.subtasks, parentId: item.id}}"></template>
        </view>
        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <view wx:if="{{item.expanded && (!item.subtasks || item.subtasks.length === 0)}}" style="font-size: 24rpx; color: #999; padding: 10rpx 0;">
          æ— å­è®¡åˆ’
        </view>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-subtasks" wx:else>
      <view class="empty-text">æ·»åŠ å­è®¡åˆ’æ¥åˆ†è§£è¿™ä¸ªä»»åŠ¡</view>
      <t-button theme="primary" size="small" bindtap="showAddSubtaskModal" class="add-btn">æ·»åŠ å­è®¡åˆ’</t-button>
    </view>
  </view>
</view>

<!-- è®¡æ—¶å™¨å¼¹çª— -->
<view class="timer-modal {{showTimer ? 'show' : ''}}">
  <view class="timer-modal-content">
    <view class="timer-header">
      <view class="timer-tabs">
        <view class="timer-tab {{timerType === 'normal' ? 'active' : ''}}" bindtap="switchTimerType" data-type="normal">æ­£è®¡æ—¶</view>
      </view>
      <t-icon name="close" size="48rpx" bindtap="hideTimerModal" class="close-icon"></t-icon>
    </view>
    
    <view class="timer-display">
      <view class="timer-circle {{timerRunning ? 'running' : ''}}" bindlongpress="longPressPause">
        <view class="timer-progress"></view>
        <view class="timer-time">{{timerDisplay}}</view>
        <view class="timer-label">{{timerRunning ? 'ä¸“æ³¨ä¸­' : 'å‡†å¤‡å¼€å§‹'}}</view>
        <view class="timer-tip">é•¿æŒ‰æš‚åœ</view>
      </view>
    </view>
    
    <view class="timer-controls">
      <t-button theme="primary" size="large" block bindtap="toggleTimer" class="timer-btn">
        {{timerRunning ? 'æš‚åœ' : 'å¼€å§‹'}}
      </t-button>
      <t-button wx:if="{{timerRunning || timerSeconds > 0}}" theme="danger" size="large" block bindtap="resetTimer" class="timer-btn">é‡ç½®</t-button>
      <t-button theme="default" size="large" block bindtap="hideTimerModal" class="timer-btn return-btn">è¿”å›</t-button>
    </view>
  </view>
</view>

<!-- æ·»åŠ /ç¼–è¾‘å­è®¡åˆ’å¼¹çª— - ç½®é¡¶æ˜¾ç¤º -->
<view class="subtask-modal {{showSubtaskModal ? 'show' : ''}}" style="z-index: 1500;">
  <view class="subtask-modal-content">
    <view class="subtask-modal-header">
      <view class="subtask-modal-title">{{editingSubtask ? 'ç¼–è¾‘å­è®¡åˆ’' : 'æ·»åŠ å­è®¡åˆ’'}}</view>
      <t-icon name="close" size="48rpx" bindtap="hideSubtaskModal" class="close-icon"></t-icon>
    </view>
    
    <view class="subtask-form">
      <!-- å­è®¡åˆ’æ ‡é¢˜è¾“å…¥ -->
      <view class="form-item">
        <view class="form-label">åç§°</view>
        <view class="input-container">
          <input 
            class="input-field" 
            value="{{subtaskTitle}}" 
            placeholder="è¯·è¾“å…¥å­è®¡åˆ’åç§°" 
            bindinput="onSubtaskTitleInput"
            maxlength="50"
          />
        </view>
      </view>
      
      <!-- å­è®¡åˆ’æè¿°è¾“å…¥ -->
      <view class="form-item">
        <view class="form-label">æè¿°</view>
        <view class="input-container">
          <textarea
            class="input-field"
            value="{{subtaskDescription}}"
            placeholder="è¯·è¾“å…¥æè¿°ä¿¡æ¯"
            bindinput="onSubtaskDescriptionInput"
            maxlength="200"
            style="min-height: 80rpx;"
          />
        </view>
      </view>
    </view>
    
    <view class="subtask-modal-footer">
      <t-button theme="primary" size="large" block bindtap="submitSubtask" class="submit-btn">ä¿å­˜</t-button>
    </view>
  </view>
</view>

<!-- å­è®¡åˆ’è¯¦æƒ…å¼¹çª— -->
<view class="subtask-detail-modal {{showSubtaskDetail ? 'show' : ''}}" style="z-index: 1400;">
  <view class="subtask-modal-content">
    <view class="subtask-modal-header">
      <view class="subtask-modal-title">å­è®¡åˆ’è¯¦æƒ…</view>
      <t-icon name="close" size="48rpx" bindtap="hideSubtaskDetailModal" class="close-icon"></t-icon>
    </view>
    
    <view class="subtask-detail-content" wx:if="{{currentSubtask}}">
      <t-cell-group>
        <t-cell title="ä»»åŠ¡åç§°" description="{{currentSubtask.title}}" bordered="{{false}}" t-class-description="cell-description"></t-cell>
        <t-cell wx:if="{{currentSubtask.description}}" title="æè¿°" description="{{currentSubtask.description}}" bordered="{{false}}" t-class-description="cell-description"></t-cell>
      </t-cell-group>
      
      <!-- å­è®¡åˆ’çš„å­è®¡åˆ’åˆ—è¡¨ -->
      <view class="nested-subtasks-section" wx:if="{{currentSubtask.subtasks && currentSubtask.subtasks.length > 0}}">
        <view class="section-header">
          <view class="section-title">
            <text>å­è®¡åˆ’åˆ—è¡¨</text>
            <text class="subtask-count">({{currentSubtask.completedSubtasksCount}}/{{currentSubtask.subtasks.length}})</text>
          </view>
        </view>
        
        <view class="nested-subtasks-list">
          <view 
            wx:for="{{currentSubtask.subtasks}}" 
            wx:key="id" 
            class="nested-subtask-item {{item.completed ? 'completed' : ''}}">
            <view class="subtask-content">
              <view class="subtask-checkbox" catchtap="toggleNestedSubtaskStatus" data-parent-id="{{currentSubtask.id}}" data-id="{{item.id}}">
                <t-icon name="{{item.completed ? 'check-circle-filled' : 'circle'}}" size="36rpx" color="{{item.completed ? '#0052d9' : '#999'}}"></t-icon>
              </view>
              <view class="subtask-info" bindtap="toggleNestedSubtaskExpand" data-parent-id="{{currentSubtask.id}}" data-id="{{item.id}}">
                <view class="subtask-title">{{item.title}}</view>
                <view class="subtask-progress" wx:if="{{item.subtasks && item.subtasks.length > 0}}">
                  <text class="subtask-children-count">{{item.completedSubtasksCount}}/{{item.subtasks.length}} å­è®¡åˆ’</text>
                  <view class="progress-bar nested">
                    <view class="progress-fill" style="width: {{item.completionPercentage}}%"></view>
                  </view>
                  <text class="progress-percentage">{{item.completionPercentage}}%</text>
                </view>
              </view>
              <view class="subtask-actions">
                <view class="subtask-action" catchtap="viewNestedSubtask" data-parent-id="{{currentSubtask.id}}" data-id="{{item.id}}">
                  <t-icon name="browse" size="32rpx" color="#666"></t-icon>
                </view>
                <view class="subtask-action" catchtap="editNestedSubtask" data-parent-id="{{currentSubtask.id}}" data-id="{{item.id}}">
                  <t-icon name="edit" size="32rpx" color="#666"></t-icon>
                </view>
                <view class="subtask-action" catchtap="deleteNestedSubtask" data-parent-id="{{currentSubtask.id}}" data-id="{{item.id}}">
                  <t-icon name="delete" size="32rpx" color="#666"></t-icon>
                </view>
              </view>
              <view class="expand-icon" wx:if="{{item.subtasks && item.subtasks.length > 0}}" catchtap="toggleNestedSubtaskExpand" data-parent-id="{{currentSubtask.id}}" data-id="{{item.id}}">
                <t-icon name="{{item.expanded ? 'chevron-up' : 'chevron-down'}}" size="32rpx" color="#666"></t-icon>
              </view>
            </view>
            
            <!-- é€’å½’å±•ç¤ºå­è®¡åˆ’çš„å­è®¡åˆ’ -->
            <view class="nested-subtasks tree-view nested-level" wx:if="{{item.expanded && item.subtasks && item.subtasks.length > 0}}">
              <template is="subtask-tree-item" data="{{subtasks: item.subtasks, parentId: item.id}}"></template>
            </view>
            <!-- è°ƒè¯•ä¿¡æ¯ -->
            <view wx:if="{{item.expanded && (!item.subtasks || item.subtasks.length === 0)}}" style="font-size: 24rpx; color: #999; padding: 10rpx 0;">
              æ— å­è®¡åˆ’
            </view>
          </view>
        </view>
      </view>
      
      <view class="subtask-detail-actions">
        <t-button theme="primary" size="small" bindtap="addNestedSubtask" class="action-btn">æ·»åŠ å­è®¡åˆ’</t-button>
        <t-button theme="default" size="small" bindtap="editCurrentSubtask" class="action-btn">ç¼–è¾‘</t-button>
        <t-button theme="danger" size="small" bindtap="deleteCurrentSubtask" class="action-btn">åˆ é™¤</t-button>
      </view>
    </view>
  </view>
</view>
